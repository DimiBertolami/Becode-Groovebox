<!DOCTYPE html>
<html>
<head>
	<title>Music Theory using Tone.js - Play Chords</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link href="MusicTheoryToneJS.css" rel="stylesheet" type="text/css">    

<!--    <script type="text/javascript" src="https://www.guitarland.com/javascripts/Tone.js"></script> -->
<!--    <script src="https://unpkg.com/tone"></script> -->
    <script type="text/javascript" src="https://tonejs.github.io/build/Tone.js"></script>
	<script type="text/javascript" src="https://www.guitarland.com/javascripts/StartAudioContext.js"></script>
    
<script>
var piano;

var MIDI_NUM_NAMES = ["C_1", "C#_1", "D_1", "D#_1", "E_1", "F_1", "F#_1", "G_1", "G#_1", "A_1", "A#_1", "B_1",
                "C0", "C#0", "D0", "D#0", "E0", "F0", "F#0", "G0", "G#0", "A0", "A#0", "B0",
                "C1", "C#1", "D1", "D#1", "E1", "F1", "F#1", "G1", "G#1", "A1", "A#1", "B1",
                "C2", "C#2", "D2", "D#2", "E2", "F2", "F#2", "G2", "G#2", "A2", "A#2", "B2",
                "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3",
                "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4",
                "C5", "C#5", "D5", "D#5", "E5", "F5", "F#5", "G5", "G#5", "A5", "A#5", "B5",
                "C6", "C#6", "D6", "D#6", "E6", "F6", "F#6", "G6", "G#6", "A6", "A#6", "B6",
                "C7", "C#7", "D7", "D#7", "E7", "F7", "F#7", "G7", "G#7", "A7", "A#7", "B7",
                "C8", "C#8", "D8", "D#8", "E8", "F8", "F#8", "G8", "G#8", "A8", "A#8", "B8",
                "C9", "C#9", "D9", "D#9", "E9", "F9", "F#9", "G9"];

function stopIt(){
//   console.log('stopIt()');
   Tone.Transport.stop();
   Tone.Transport.cancel(0);
//   if(piano) {
//       piano.dispose();
//       piano = null;
//   }
}

function updateTempo()  {
	var tempo = document.myForm.tempo.value;
	Tone.Transport.bpm.value = tempo   
}
function updateTempo2()  {
	var tempo = document.myForm2.tempo2.value;
	Tone.Transport.bpm.value = tempo   
}

var root; // let user choose
var familyOfTriads = [[0,4,7],[0,3,7],[0,3,6],[0,4,8]];
var MAJOR_SCALE = [0,2,4,5,7,9,11,12];
var NATURAL_MINOR_SCALE = [0,2,3,5,7,8,10,12];
var HARMONIC_MINOR_SCALE = [0,2,3,5,7,8,11,12];
var MELODIC_MINOR_SCALE = [0,2,3,5,7,9,11,12];


function getScaleFormula() {
   console.log("getScaleFormula()")
   var scaleTypeMenu = document.getElementById("scaleType");
   var scaleType = scaleTypeMenu.options[scaleTypeMenu.selectedIndex].value;
   if(scaleType === "Major") {
       return MAJOR_SCALE;
   } else if(scaleType === "NaturalMinor") {
       return NATURAL_MINOR_SCALE;
   } else if(scaleType === "HarmonicMinor") {
       return HARMONIC_MINOR_SCALE;
   } else if(scaleType === "MelodicMinor") {
       return MELODIC_MINOR_SCALE;
   } else {
       return NATURAL_MINOR_SCALE;
   }
}


function makeChordArray(root, chordFormula, timeInterval) {
//    console.log("makeChordArray");
    var indexMIDI
    var aChord = [];
    var timeAndChord = [];
    let cummulativeTime = Tone.Time('0');
    var chordArray = [];
    updateTempo();
    updateTempo2();
    for(let i=0; i<chordFormula.length; i++) {
        for(var j=0; j<chordFormula[i].length; j++) {
            // add the root to each chord tone
            indexMIDI = chordFormula[i][j] + Number(root);
            // tranlate to a pitch/octave name
            aChord.push(MIDI_NUM_NAMES[indexMIDI]);
        }
		// create add time and chord together
		timeAndChord.push(Tone.Time(cummulativeTime).toSeconds());
		timeAndChord.push(aChord);
        chordArray.push(timeAndChord);
        cummulativeTime = Tone.Time(Tone.Time(cummulativeTime) + Tone.Time(timeInterval));
//        console.log('2: cummulativeTime='+Tone.Time(cummulativeTime).toSeconds()+' timeInterval='+timeInterval+' toneTime='+toneTime);
		// clear the arrays;
		aChord = [];
		timeAndChord = [];
    }
    console.log(chordArray);
    return chordArray;
}


/*--------------------------------------------------------
//	PIANO
var piano = new Tone.PolySynth(4, Tone.Synth, {
	"volume" : -8,
	"oscillator" : {
		"partials" : [1, 2, 5],
	},
	"portamento" : 0.005
}).toMaster()
//------------------------------------------------------*/

function playFamilyOfTriads() {
//    console.log("playFamilyOfTriads");
    var rootMenu = document.getElementById("root");
    root = rootMenu.options[rootMenu.selectedIndex].value;
    myChords = makeChordArray(root, familyOfTriads, '2n');
    if(!piano) {
		piano = new Tone.PolySynth(Tone.Synth, {
			"volume" : -8,
			"oscillator" : {
				"partials" : [1, 2, 5],
			},
			"portamento" : 0.005
		}).toDestination();
    }
	var tempo = document.myForm.tempo.value;
	Tone.Transport.bpm.value = tempo;   

	var chordPart = new Tone.Part(function(time, chord){
		piano.triggerAttackRelease(chord, "2n", time);
	}, myChords ).start(0);

	chordPart.loop = true;
	chordPart.loopStart = "0:0";
	chordPart.loopEnd = "2:0";

	Tone.Transport.start("+0.1");
}

var romanNumeralToIndex = {
    "I": 0,
    "II": 1,
    "III": 2,
    "IV": 3,
    "V": 4,
    "VI": 5,
    "VII": 6,
};

function createDiatonicTriadFormula_OneOctave(scaleDegreeRoot, scale) {
	var useMajorV = document.myForm2.V_Major.checked;
    var oneChord = [];
    oneChord.push(scale[scaleDegreeRoot % 7]);
    if(useMajorV && scaleDegreeRoot==4 && scale == NATURAL_MINOR_SCALE) {
        oneChord.push(scale[(scaleDegreeRoot+2) % 7]+1);
    } else {
        oneChord.push(scale[(scaleDegreeRoot+2) % 7]);
    }
    oneChord.push(scale[(scaleDegreeRoot+4) % 7]);
    return oneChord;
}


function playChordProgression() {
//    console.log("playChordProgression");
    var rootMenu = document.getElementById("root2");
    root = rootMenu.options[rootMenu.selectedIndex].value;
    
    var chordMenu = document.getElementById("chordProgressions");
    var chordProgStr = chordMenu.options[chordMenu.selectedIndex].value;
    var chordProgArr = chordProgStr.split("-");
    var oneChord = [];
    var chordArray = [];
    var scale = getScaleFormula();
    
    for(let i=0; i<chordProgArr.length; i++) {
        var index = romanNumeralToIndex[chordProgArr[i]];
        oneChord = createDiatonicTriadFormula_OneOctave(index, scale);
        chordArray.push(oneChord);
    }
    myChords = makeChordArray(root, chordArray, '2n');
    if(!piano) {
		piano = new Tone.PolySynth(Tone.Synth, {
			"volume" : -8,
			"oscillator" : {
				"partials" : [1, 2, 5],
			},
			"portamento" : 0.005
		}).toDestination();
    }

	var tempo = document.myForm2.tempo2.value;
	Tone.Transport.bpm.value = tempo;   

	var chordPart = new Tone.Part(function(time, chord){
		piano.triggerAttackRelease(chord, "2n", time);
	}, myChords ).start(0);

	chordPart.loop = true;
	chordPart.loopStart = "0:0";
	chordPart.loopEnd = "2:0";

	Tone.Transport.start("+0.1");
}


</script>
</head>

<body>
<div id="Content">
<h1>Play Chords</h1>
<p>The music theory content can be found at <a href="http://www.guitarland.com/Music10/MusFund/Triads/Triads.html" target="_blank">Music Fundamentals on the Web.</a></p>
<p>
The playing of chords using Tone.js involves playing an array of note names or frequencies at the same time.  With scales we played a single note followed by another single note.  Now we need to play a small array of notes (simultaneously) followed by another small array of notes.  We start with triads but the concept is easily extended to more complex chords.  Our array of chords will consist of an arbitrary length array consisting of sub-arrays of length 3 (representing the three note of the triad.)  In addition we'll need to have a time value for each chord so each element in our main array will be a two element array itself (time value and chord array). 
</p>
<h2>Triads</h2>
<p>
Just as we defined the interval structure of a scale with an array of numbers, we can similarly define the interval structure of chords with an array of numbers.  Using the definitions of the major chords as listed below you can see the equivalent structure translated into an array of numbers.  The root of the chord is listed as the number 0, then a root can be defined outside of this structure and it is easy to tranpose it to any root MIDI number.  The second number (4) is the number of half steps in a major third.  The third number (7) is the number of half steps in a perfect fifth.
</p>
<ul>
<li>Major triad is defined as the first, third and fifth note of a major scale.
</li>
<li>MajorTriad = [0,4,7]
</li>
<li>Minor triad is created by lowering the third a half step.
</li>
<li>MinorTriad = [0,3,7]
</li>
<li>Diminished triad is created by lowering the fifth of a minor triad.
</li>
<li>DiminishedTriad = [0,3,6]
</li>
<li>Augmented Triad is defined raising the fifth of a major triad.
</li>
<li>AugmentedTriad = [0,4,8]
</li>
</ul>
<p>
As a first demonstration we set up an array of chords that plays all four types of triads (at a constant rhythm) for any selected root.  The basic array is modified by the variable <b>root</b>, the resulting array of numbers are translated into note names using the MIDI_NUM_NAMES translation array.  This will give us the correct sounds (but not necessarily the correct names) for the triads.  And because this array uses only sharp names, it will spell the Eb major triad as D#,G,A#.  It will sound correct, but you wouldn't want to print it out with that spelling.
</p>

<pre><code>
// var root; // let user choose
var familyOfTriads = [[0,4,7],[0,3,7],[0,3,6],[0,4,8]];

function makeChordArray(root, chordFormula, timeInterval) {
    var indexMIDI
    var aChord = [];
    var timeAndChord = [];
    var toneTime = 0;
    var chordArray = [];
    for(let i=0; i&lt;chordFormula.length; i++) {
        for(let j=0; j&lt;chordFormula[i].length; j++) {
            // add the root to each chord tone
            indexMIDI = chordFormula[i][j] + Number(root);
            // tranlate to a pitch/octave name
            aChord.push(MIDI_NUM_NAMES[indexMIDI]);
        }
        j = 0;
        // create add time and chord together
        timeAndChord.push(toneTime.toNotation());
        timeAndChord.push(aChord);
        chordArray.push(timeAndChord);
        // now calc the time value for next time
        toneTime = toneTime.add(timeInterval);
        // clear the arrays;
        aChord = [];
        timeAndChord = [];
    }
    return chordArray;
}

// assume the user selects from a menu option such as the following
&lt;select id="root"&gt;
&lt;option value=57&gt;A
&lt;option value=58&gt;Bb
&lt;option value=59&gt;B
&lt;option value=60&gt;C
...
&lt;/select&gt;

// root = user's selection, i.e. "C" = root=60
</code></pre>

<p>Now we can use some code similar to PlayScale.  Well make this version specific to our one goal and call the new function playFamilyOfTriads(). 
</p>

<pre><code>
//	PIANO
var piano = new Tone.PolySynth(Tone.Synth, {
    "volume" : -8,
    "oscillator" : {
        "partials" : [1, 2, 5],
    },
    "portamento" : 0.005
}).toDestination();


function playFamilyOfTriads() {
    var rootMenu = document.getElementById("root");
    var root = rootMenu.options[rootMenu.selectedIndex].value;

    // this line is hardwired to the familyOfTriads global array, 
    // that will need to change to make this a more useful function
    var myChords = makeChordArray(root, familyOfTriads, '2n');

	var chordPart = new Tone.Part(function(time, chord){
		piano.triggerAttackRelease(chord, "2n", time);
	}, myChords ).start(0);

	chordPart.loop = true;
	chordPart.loopStart = "0:0";
	chordPart.loopEnd = "2:0";

	var tempo = document.myForm.tempo.value;
	Tone.Transport.bpm.value = tempo;   
	Tone.Transport.start("+0.1");
}

</code></pre>

<form name="myForm">
<select name='root' id='root'>
<option value=57>A
<option value=58>Bb
<option value=59>B
<option value=60>C
<option value=61>C#
<option value=61>Db
<option value=62>D
<option value=63>Eb
<option value=64>E
<option value=65>F
<option value=66>F#
<option value=66>Gb
<option value=67>G
<option value=68>Ab
<option value=69>A
</select>
<input type="button" class="playButton" VALUE="Play Triads" id="playChordsButton">
<input type="button" class="stopButton" VALUE="Stop" onclick="stopIt()">

| tempo:<select name="tempo" onchange="updateTempo()">
    <option value=60>60</option>
    <option value=70>70</option>
    <option value=80>80</option>
    <option value=90>90</option>
    <option value=100>100</option>
    <option value=110>110</option>
    <option value=120>120</option>
    <option value=130>130</option>
    <option value=140>140</option>
    <option value=160>160</option>
    <option value=180>180</option>
    <option value=200>200</option>
</select>

</form>

<hr>
<p>Let's modify the function to be more general purpose.  We want the user to be able to select which chords to play, even if its limited to a list from a menu.  So we want a playChords() function that can play any defined array of chords.  Notice that the inner loop in <b>makeChordArray()</b> tests if j&lt;chordFormula[i].length, this means that it isn't restricted to only three note triads but it can process whatever length that chord sub-array is.  So that part of the code is good for a variety of chord types.  But to make playFamilyOfTriads() more general (i.e. playChords() ) we need to extract the hardcoded <b>familyOfTriads</b> array and let that be a variable whose value is determined by the user.
</p>

<h2>Diatonic Triads</h2>

<p>On a musical level when we are in the context of a scale such as the major scale, you also have an entire family of diatonic chords from that scale.  We label those chords with roman numerals: I II III IV V VI VII with each root being the scale degree of that roman numeral.  For example in the key of C major the roots of the roman numeral chords are (respectively) C D E F G A B.  For the major scale the quality of the chords (major, minor, diminished or augmented) has a consistent order for all major scales. 
</p>
<p>For major scales: Diatonic triads
</p>

<ul>
<li>I = major triad
</li>
<li>II = minor triad
</li>
<li>III = minor triad
</li>
<li>IV = major triad
</li>
<li>V = major triad
</li>
<li>VI = minor triad
</li>
<li>VII = diminished triad
</li>
</ul>
<p>NOTE: there are no augmented triads created with notes from only a major scale.  Also, many people use lowercase roman numerals for minor and diminished triads.  If that style of notation is used then the diatonic triads are labeled: I ii iii IV V vi vii.  However, I'll use capital roman numerals for ALL chord types (without it defining chord quality) because we'll be switching between major and minor keys while using the same roman numeral chord progression.
</p>
<p>
While it might be tempting to create an array of these structures to use in the context of major scale there is a more general method that will also work for the three form of minor.  The diatonic triads are created by combining a interval of a diatonic third and fifth above any of the scale tones (which is labeled as the 'root' of the triad).  So for C major:
</p>
<ul>
<li>I chord = C E G (major)</li> 
<li>II chord is D F A (minor)</li> 
<li>III chord = E G B (minor)</li>
<li>IV chord = F A C (major)</li>
<li>V chord = G B D (major)</li>
<li>VI chord = A C E (minor)</li>
<li>VII chord = B D F (diminished)</li>
</ul>
<p>The major scale always has the order of quality: major, minor, minor, major, major, minor, diminished.  But a different scale will have different quality chords at those specific roman numerals.  Each of the three forms of minor has its own unique series of chords. For A harmonic minor:
</p>
<ul>
<li>I chord = A C E (minor)</li> 
<li>II chord is B D F (diminished)</li> 
<li>III chord = C E G# (augmented)</li>
<li>IV chord = D F A (minor)</li>
<li>V chord = E G# B (major)</li>
<li>VI chord = F A C (major)</li>
<li>VII chord = G# B D (diminished)</li>
</ul>
<p>So a general approach to diatonic chords is to calculate a <b>root, third, fifth on each scale degree</b> on whichever scale we are working with.  This approach allows us to explore, for example, the I V VI IV chord progression in major or three forms of minor using the same underlying code.  In fact why limit ourselves to just root, third and fifth patterns from the scale.  We can design it so that ANY combination of notes from the scale can be used to create a chord.
</p>

<h2>Inversions</h2>
<p>Triads and other chords can be played in the basic voicing from low to high: root, third, fifth (known as root position).  But they also can be voiced with either the third or the fifth as the lowest note.  These addition voicings are known as inversions of the triad.
</p>
<dl>
<dt>Root Position</dt>
<dd>
The basic voicing from low to high: root, third, fifth (usually).  Even if the third is above the fifth, as long as the root is the lowest tone it's in root position.  
</dd>
<dt>First Inversion</dt><dd>
When the third of the chord is the lowest note it is called 1st inversion. 
</dd>
<dt>Second Inversion</dt>
<dd>
When the fifth of the chord is the lowest note it is called 2nd inversion.  
</dd>
</dl>
<p>
If we use inversions on some of the roman numerals we can voice all of diatonic (I II III IV V VI VII) triads within a single octave.
</p>
<p>
Before we get to creating our diatonic chords in major and each of the three forms of minor, I want to emphasise an important characteristic of minor keys:  Any of these three forms can be used during a phrase in a minor key.  A common minor key chord progression is [ Am - G - F - E ]=[ I VII VI V ]  This chord progression is sometimes referred to as the Andalusian Cadence, but I know it as 'Hit the Road Jack' and others recognize it as 'Stray Cat Strut'.  Bach has some hits using this progression also.  This chord progression shows the mixture of both natural minor and harmonic minor.  The G chord lives in A natural minor (but not A harmonic minor [G#dim]) and the E chord lives in A harmonic minor (but not A natural minor [Em])  The Am and F chords are in both the natural and harmonic minor forms.  So in addition to having diatonic chords of each minor type we need some way of mixing the types within a single chord progression.  One common approach is to modify the V chord of the natural minor form to become a major triad (in natural minor the V chord is minor).  That would allow for the Andalusian Cadence to be used when the scale type is natural minor.  This seems like a good feature to be able to turn on and off with a checkbox.  We'll incorporate that idea into the next section.
</p>
<p>
Again we can use the remainer operator (%), this time to help keep our triads within an octave range.  Assume we have a scale formula like major [0,2,4,5,7,9,11,12].  our triads are created by starting at any of the scale degrees and taking every other value for a total of 3 values. The pattern is [index,index+2,index+4]. For example, the I chord uses the values at indices 0,2,4, II chord use the values at indices 1,3,5 etc. But if we try to build a triad starting on index 4 of this array our last note's index will try to access something out-of-bounds (4,6,8).  The remainder operator (%) provides a solution.  There are seven different letter names in the scale.  If we use (indexNumber %7) we'll force the index number to stay within our scale boundary. In many cases the resulting chord will be an inversion of the triad. 
</p>
<ul>
<li>MajorFormula = [0,2,4,5,7,9,11,12]</li>
<li>I chord uses the values at indices 0 %7, 2 %7, 4 %7 which equals [0,4,7] - root position</li>
<li>II chord use the values at indices 1 %7, 3 %7, 5 %7 which equals [2,5,9] - root position</li>
<li>III chord has the values at indices 2 %7, 4 %7, 6 %7 which equals [4,7,11] - root position</li>
<li>IV chord has the values at indices 3 %7, 5 %7, 7 %7 which equals [5,9,0] - second inversion</li>
<li>V chord has the values at indices 4 %7, 6 %7, 8 %7 which equals [7,11,2] - second inversion</li>
<li>VI chord has the values at indices 5 %7, 7 %7, 9 %7 which equals [9,0,4] - first inversion</li>
<li>V chord has the values at indices 6 %7, 8 %7, 10 %7 which equals [11,2,5] - first inversion</li>
</ul>
<p>
These voicing are a limited set and they don't allow us the kind of voiceleading that we would want.  But as a first iteration of chord progressions code we'll select chords from a diatonic family that have these voicings.  We'll allow the user to select from a menu a roman numeral chord progression and a key and scale type.  Plus our check box that will modify the V chord in natural minor so that the third of the chord is raised a half step (one MIDI number) which will make the V chord a major quality chord (instead of minor).  The chords are the correct notes but many times there is a preferred different voiceleading.  We'll work on that in a later version.
</p>
<p>
<form name="myForm2">
chord progression | <select id="chordProgressions" name="chordProgressions">
<option value"I-IV-V-I">I-IV-V-I</option>
<option value"I-VII-VI-V">I-VII-VI-V</option>
<option value"I-V-IV-V">I-V-IV-V</option>
<option value"I-V-VI-IV">I-V-VI-IV</option>
<option value"II-V-I-VI">II-V-I-VI</option>
<option value"I-II-III-IV">I-II-III-IV</option>
<option value"I-III-IV-I">I-III-IV-I</option>
<option value"IV-I-V-VI">IV-I-V-VI</option>
<option value"IV-V-I-IV">IV-V-I-IV</option>
</select>

<select name='root2' id='root2'>
<option value=57>A
<option value=58>Bb
<option value=59>B
<option value=60>C
<option value=61>C#
<option value=61>Db
<option value=62>D
<option value=63>Eb
<option value=64>E
<option value=65>F
<option value=66>F#
<option value=66>Gb
<option value=67>G
<option value=68>Ab
<option value=69>A
</select>
<input type="button" class="playButton" VALUE="Play Chord Progression" id="playChordProgressionButton">
<input type="button" class="stopButton" VALUE="Stop" onclick="stopIt()">

| tempo:<select name="tempo2" onchange="updateTempo2()">
    <option value=60>60</option>
    <option value=70>70</option>
    <option value=80>80</option>
    <option value=90>90</option>
    <option value=100>100</option>
    <option value=110>110</option>
    <option value=120>120</option>
    <option value=130>130</option>
    <option value=140>140</option>
    <option value=160>160</option>
    <option value=180>180</option>
    <option value=200>200</option>
</select>

 Scale type:<select name="scaleType" id="scaleType">
    <option value="Major">Major</option>
    <option value="NaturalMinor">Natural Minor</option>
    <option value="HarmonicMinor">Harmonic Minor</option>
    <option value="MelodicMinor">Melodic Minor</option>
</select>
<label><input type="checkbox" name="V_Major" id="V_Major" value="V_Major"> use major V on natural minor </label>
</form>
</p>

<div id="dynamicDisplay"></div>
<p>
<a href="TonejsSetup.html">Back to the Tone.js Setup page.</a>
</p>
<script>
    var button1 = document.getElementById("playChordsButton");
    button1.onclick = playFamilyOfTriads;
    var button2 = document.getElementById("playChordProgressionButton");
    button2.onclick = playChordProgression;

</script>

<!-- Content Mother of all divs -->
</div>
<div id="footer"></div>
<script src="lastModified.js"></script>
</body>
</html>